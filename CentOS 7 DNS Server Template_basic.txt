# Centos 7 DNS Server Template
# Operating System: CentOS 7 64-bit with Gnome GUI
# Purpose: to create a functional template for Bind DNS implementation

# By Brendan Marentette
# mare0034@algonquinlive.com
# Created: 2020-09-18
# Last Update: 2020-09-23


# SYSTEM INFORMATION:
# Hostname: Temp-server.lab


##################### INITIAL SYSTEM SETUP  #####################


# Initial Updates
su
yum update && yum upgrade

# enable EPEL repository
yum install epel-release

# OPTIONAL: Disable Firewall
systemctl stop firewalld
systemctl disable firewalld

# Disable SELinux
vim /etc/sysconfig/selinux
# change "enforcing" parameter to "disabled"

# Hostname Config
hostnamectl set-hostname Temp-server.lab

# Modify GRUB file:
vim /etc/default/grub
# remove option: rhgb quiet
grub2-mkconfig -o /boot/grub2/grub.cfg

################### CONFIGURE BASIC NETWORKING ###################

# install networking tools (if missing)
yum install net-tools
yum install netscript-2.4

# disable NetworkManager service
systemctl disable NetworkManager.service
systemctl stop NetworkManager.service
# Check if dhclient is running; kill process:
ps -f

# enable network service
systemctl enable network
systemctl start network

# edit default interface configuration
cd /etc/sysconfig/network-scripts
# determine interface id
vim /etc/sysconfig/network-scripts/ifcfg-[id]
# set ONBOOT=yes
# comment out IPv6 parameters if not needed
# delete NetworkManager parameters:
#	- NM_CONTROLLED=no
#	- PEERROUTES

# complete any other networking configurations now. such as:
# 	- adding interface config files
#	- add alias interface (see "IP Alias If Command.txt"

################### MISC UTILITIES ###################

# OPTIONAL: install python
yum install python36

# OPTIONAL: enable NTFS filesystem support
yum install ntfs-3g

#####################################################################
################### BIND DNS SERVER CONFIGURATION  ##################
#####################################################################

# Recommended: Monitoring DNS syslog during setup (use either option)
journalctl –f –u named
tail –f /var/log/messages

# Part 1) Installing a Name Server

# A) Install Name Server
# Centos:
sudo yum update && sudo yum upgrade
sudo yum install bind
# note: service is called bind
# packages include: bind, bind-utils,bind-libs
# note (Centos): bind configuration, /etc/named.conf

# add exceptions to firewalld rules (Centos)
firewall-cmd --permanent --add-port=53/tcp
firewall-cmd --permanent --add-port=53/udp
firewall-cmd –reload
firewall-cmd --list-all

# /etc/named.conf example (adding zones)
# note: recommend to use absolute paths to the files; avoids issues relating to the directory directive
: '
zone "." IN {
type hint;
file "named.ca";
};
zone "example.com" IN {
type master;
file "/etc/bind/fwd.example.com";
allow-update { none; };
};
zone "195.168.192.in-addr.arpa" IN {
type master;
file "/etc/bind/rvs.example.com";
allow-update { none; };
};
include "/etc/named.rfc1912.zones";
include "/etc/named.root.key";
'

# FORWARD ZONE CONFIG EXAMPLE
: '
$TTL 2D
@ IN SOA server.example.com. root.example.com. (
					0 ; serial
					1D ; refresh
					1H ; retry
					1W ; expire
					3H ) ; minimum
@ IN NS server.example.com.
@ IN A 192.168.195.240
server IN A 192.168.195.240
host IN A 192.168.195.240
desktop IN A 192.168.195.239
client IN A 192.168.195.239
'

# REVERSE ZONE CONFIG EXAMPLE
: '
$TTL 1D
@ IN SOA server.example.com. root.example.com. (
					0 ; serial
					1D ; refresh
					; retry
					1W ; expire
					3H ) ; minimum
@ 		IN NS server.example.com.
@ 		IN PTR example.com.
server 	IN A 192.168.195.240
host 	IN A 192.168.195.240
desktop IN A 192.168.195.239
client 	IN A 192.168.195.239
240 	IN PTR server.example.com
239		IN PTR client.example.com
'

# read new zone data file (on slave)
rndc reconfig

# configure /etc/resolv.conf
vim /etc/resolv.conf
# RESOLV CONFIG EXAMPLE
: '
# Generated by NetworkManager
search example.com
nameserver 192.168.195.240
'

# change ownership of zone files
# note: service account is bind in Ubuntu and named in Centos
chown root:named fwd.example.com
chown root:named rvs.example.com

# Verify configs
named-checkconf -z /etc/named.conf
named-checkzone forward /var/named/fwd.example.com
named-checkzone reverse /var/named/rvs.example.com

# *** secondary server setup ***

# A) Install Name Server on second server
# Centos:
sudo yum update && sudo yum upgrade
sudo yum install bind
# Ubuntu:
sudo apt-get install bind9 bind9utils bind9-doc dnsutils

# named.conf / named.conf.local CONFIG EXAMPLE FOR MASTER
# append options; add zones as needed
: '
 
 allow-recursion { 172.16/16;127.0.0.1; };
	allow-transfer	{ 172.16.31.58; };
	notify	yes;
	also-notify	{ 172.16.31.58; };
	allow-query     { localhost;172.16/16; };
 

 
 zone "example.com" {
             type master;
             file "/etc/bind/db.example.com";
             allow-transfer { @ip_secondary; };
        };

        [...]

        zone "1.168.192.in-addr.arpa" {
             type master;
             notify no;
             file "/etc/bind/db.192";
             allow-transfer { @ip_secondary; };
        };
'

# named.conf / named.conf.local CONFIG EXAMPLE FOR SLAVE
: '
       [...]

        zone "example.com" {
             type slave;
             file "/var/cache/bind/db.example.com";
             masters { @ip_master; };
        };

        [...]

        zone "1.168.192.in-addr.arpa" {
             type slave;
             file "/var/cache/bind/db.192";
             masters { @ip_master; };
        };

        [...]
'

# TROUBLESHOOTING

named-checkzone marentette.cloud /etc/bind/fwd.marentette.cloud

# VERIFICATION & TESTING

# check lookup speed
time dig google.com @ns1

# Syntax for hostname resolution: 
# dig [@nameserver] fqdn

# Reverse lookup
# dig -x IP_address_of_host

# Name server lookup
# Syntax: dig record_type domain_name
# Note: This syntax allows you to look up any resource record type: 
#	- eg. such as MX or SOA, for a given domain
# Example: dig NS google.ca

# Lookup using a specific name server
# dig @nameserver fqdn

# Delegation tree: 
# dig fqdn +trace
